# Perform a Packer build based on the `packer.json` configuration. This Packer
# build creates a GCE image.
# # To run the build manually do the following,
#      $ `gcloud builds submit --config=cloudbuild.yaml .`
#

steps:
- name: 'gcr.io/cloud-builders/gcloud'
  args:
  - kms
  - decrypt
  - --ciphertext-file=account.enc
  - --plaintext-file=account.json
  - --location=global
  - --keyring=packer
  - --key=packer

- name: 'gcr.io/cloud-builders/gcloud'
  args:
    - kms
    - decrypt
    - --ciphertext-file=hpc_etc_id_rsa.enc
    - --plaintext-file=/root/.ssh/id_rsa
    - --location=global
    - --keyring=packer
    - --key=packer
  volumes:
    - name: 'ssh'
      path: /root/.ssh

- name: 'gcr.io/cloud-builders/gcloud'
  args:
    - kms
    - decrypt
    - --ciphertext-file=hpc_etc_id_rsa.enc
    - --plaintext-file=id_rsa
    - --location=global
    - --keyring=packer
    - --key=packer
  volumes:
    - name: 'ssh'
      path: /root/.ssh

- name: 'gcr.io/cloud-builders/git'
  entrypoint: 'bash'
  args:
  - '-c'
  - |
    chmod 600 /root/.ssh/id_rsa
    cat <<EOF >/root/.ssh/config
    Hostname github.com
    IdentityFile /root/.ssh/id_rsa
    EOF
    cp -p github_known_hosts /root/.ssh/known_hosts
  volumes:
    - name: 'ssh'
      path: /root/.ssh

- name: 'gcr.io/$PROJECT_ID/packer'
  args:
  - build
  - -var
  - project_id=$PROJECT_ID
  - packer.json

timeout: 1200s
tags: ['packer-gce-goss']
