{
  "variables": {
    "build_type": "full",
    "date": "{{isotime \"2006-01-02\"}}",
    "image_role": "base",
    "image_version": "2",
    "image_description ": "packer-image",
    "image_family": "nyuhpc-centos-8",
    "os_name": "centos",
    "os_version": "8",
    "project_id": "hpc-image-builder",
    "source_image_family": "centos-8",
    "ssh_user": "packer",
    "zone": "us-central1-a"
  },

  "builders": [
    {
      "type": "googlecompute",
      "account_file": "secrets.json",
      "image_name": "{{ user `os_name` }}-{{ user `os_version` }}-{{ user `image_role` }}-{{ user `build_type` }}-{{ user `date` }}-v{{ user `image_version` }}",
      "image_family": "{{ user `image_family` }}",
      "project_id": "{{ user `project_id` }}",
      "ssh_username": "{{ user `ssh_user` }}",
      "source_image_family": "{{ user `os_name` }}-{{ user `os_version` }}",
      "state_timeout": "8m",
      "zone": "{{ user `zone` }}"
    }
  ],
      "provisioners" : [
      {
        "type": "shell",
        "inline": [ "sudo dnf -y install epel-release" ]
      },
      {
        "type": "shell",
        "inline": [ 
          "sleep 10",
          "sudo dnf -y install ansible" 
        ]
      },
      {
        "type": "shell",
        "inline": [ "sudo dnf -y config-manager --disablerepo epel" ]
      },
      {
        "type": "ansible-local",
        "playbook_file": "ansible/playbooks/{{ user `os_name` }}-{{ user `os_version` }}-{{ user `image_role` }}-{{ user `build_type` }}.yml",
        "playbook_dir": "./ansible",
        "playbook_paths": [ "./ansible/playbooks" ],
        "role_paths": [
          "./ansible/roles",
          "./ansible/roles/local"
        ],
        "clean_staging_directory": true
      }
    ]
}
